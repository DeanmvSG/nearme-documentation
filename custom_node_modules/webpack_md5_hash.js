/*
    This file is a custom implementation of https://www.npmjs.com/package/webpack-md5-hash
    Due to an issue with chunkHash strings being different on different machines
    ttps://github.com/webpack/webpack/issues/1315

    I am removing context url from absolute paths to the folder, which should result in the same md5 hash
*/

var md5 = require("md5");

function compareModules(a,b) {
    if (a.resource < b.resource)
        return -1;
    if (a.resource > b.resource)
        return 1;
    return 0;
}

function getModuleSource (module) {
    var _source = module._source || {};
    return _source._value || "";
}

function concatenateSource (result, module_source) {
    return result + module_source;
}

function WebpackMd5Hash () {

}

WebpackMd5Hash.prototype.apply = function(compiler) {
    compiler.plugin("compilation", function(compilation) {
        var context = compilation.options.context.replace(/\//g,'\/');
        compilation.plugin("chunk-hash", function(chunk, chunkHash) {
            var source = chunk.modules.sort(compareModules).map(getModuleSource).reduce(concatenateSource);
            source = source.replace(new RegExp(context, 'g'), '');
            var chunk_hash = md5(source);
            chunkHash.digest = function () {
                return chunk_hash;
            };
        });
    });
};

module.exports = WebpackMd5Hash;
