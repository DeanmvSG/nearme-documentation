<script type="text/javascript">

  $(document).ready(function() {

    var map = new google.maps.Map(document.getElementById("listings_map"), {
      zoom: 8,
      mapTypeId: google.maps.MapTypeId.ROADMAP,
      mapTypeControl: false
    });

    var bounds = new google.maps.LatLngBounds();
    var markers = {};
    var info_window = new google.maps.InfoWindow();

    <% @listings.each do |w| %>
      ll = new google.maps.LatLng(<%= w.latitude %>, <%= w.longitude %>);
      bounds.extend(ll);
      markers[<%= w.id %>] = new google.maps.Marker({
        position: ll,
        map: map,
        icon: "<%= image_path("marker.png") %>",
        title: "<%= w.name %>"
      });
      google.maps.event.addListener(markers[<%= w.id %>], 'click', function() {
        info_window.setContent("<%= escape_javascript(render(:partial => 'listings/gmap', :locals => { :listing => w })) %>");
        info_window.open(map, markers[<%= w.id %>]);
      });
    <% end %>
    map.fitBounds(bounds);

  });

</script>
