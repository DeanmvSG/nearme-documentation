- collapsed ||= false
- listing = listing.decorate
- old = lookup_context.transactable_type_id
- lookup_context.transactable_type_id = listing.transactable_type_id if old != listing.transactable_type_id
.booking-module-container{:class => "#{booking_module_class(listing)} #{collapsed ? " collapsed" : ""}", :'data-toggleable-booking-module' => true, id: "booking-module-#{listing.id}"}
  .booking-module
    .booking-header
      %a.toggleable-booking-trigger{:href => location_path(listing.location, listing), :'data-booking-trigger' => true}
        %span.pull-right
          %i.ico-chevron-down
          %i.ico-chevron-right
        %span.booking-listing-name= mask_phone_and_email_if_necessary(listing.name)

    .booking-price-info
      %span= price_information(listing)
    .booking-body
      .booking-price
        - if listing.schedule_booking?
          - if listing.fixed_price.to_f > 0
            %span.label
              = "#{listing.price_with_currency(:fixed_price)}"
              - if listing.price_per_unit?
                %span.period= t('reservations.booking_module.per_unit')
              -else
                %span.period= t('reservations.booking_module.fixed')
          - if listing.exclusive_price.to_f > 0
            %span.label{style: "#{'float: right;' if listing.fixed_price.to_f > 0}"}
              = "#{listing.price_with_currency(:exclusive_price)}"
              %span.period= t('simple_form.labels.transactable.price.exclusive_price')
          - if listing.action_free_booking?
            %ul.pricing-tabs.nav.nav-tabs
              %li
                %span.label
                  = t 'booking_module.free'
        - else
          %ul.pricing-tabs.nav.nav-tabs{:'data-pricing-tabs' => true}
            - if listing.action_free_booking?
              = content_tag :li, data: { daily: true } do
                = link_to "#daily-booking-#{listing.id}", class: "#{'possible' if listing.action_free_booking? }" do
                  %span.label
                    = t 'booking_module.free'
            - if listing.action_hourly_booking?
              = content_tag :li, data: { hourly: true } do
                = link_to "#hourly-booking-#{listing.id}", class: "#{'possible' unless listing.hourly_price.to_f.zero? }" do
                  %span.label
                    - unless listing.hourly_price.to_f.zero?
                      = "#{listing.price_with_currency(:hourly_price)}"
                    - else
                      = '-'
                    %span.period= t('reservations.per_hour')
            - if listing.action_daily_booking?
              - if listing.transactable_type.action_daily_booking
                = content_tag :li, data: { daily: true } do
                  = link_to "#daily-booking-#{listing.id}", class: "#{'possible' unless listing.daily_price.to_f.zero? }" do
                    %span.label
                      - unless listing.daily_price.to_f.zero?
                        = "#{listing.price_with_currency(:daily_price)}"
                      - else
                        = '-'
                      %span.period= listing.overnight_booking? ? t('reservations.per_night') : t('reservations.per_day')

              - if listing.transactable_type.action_weekly_booking
                %li
                  = link_to "#daily-booking-#{listing.id}", class: "#{'possible' unless listing.weekly_price.to_f.zero? }" do
                    %span.label
                      - unless listing.weekly_price.to_f.zero?
                        = "#{listing.price_with_currency(:weekly_price)}"
                      - else
                        = '-'
                      %span.period= t('reservations.per_week')

              - if listing.transactable_type.action_monthly_booking
                %li
                  = link_to "#daily-booking-#{listing.id}", class: "#{'possible' unless listing.monthly_price.to_f.zero? }" do
                    %span.label
                      - unless listing.monthly_price.to_f.zero?
                        = "#{listing.price_with_currency(:monthly_price)}"
                      - else
                        = '-'
                      %span.period= t('reservations.per_month')
            - unless listing.weekly_subscription_price.to_f.zero?
              %li{ data: { subscription: 'weekly' } }
                = link_to "#recurring-booking-#{listing.id}", class: "possible" do
                  %span.label
                    = "#{listing.price_with_currency(:weekly_subscription_price)}"
                    %span.period= t('reservations.per_week')

            - unless listing.monthly_subscription_price.to_f.zero?
              %li{ data: { subscription: 'monthly' } }
                = link_to "#recurring-booking-#{listing.id}", class: 'possible' do
                  %span.label
                    = "#{listing.price_with_currency(:monthly_subscription_price)}"
                    %span.period= t('reservations.per_month')

      .clearfix
      = render 'locations/booking_module_listing_description', listing: listing

      - if listing.actions_allowed?
        - unless listing.schedule_booking?
          .tab-content
            .calendar-wrapper.date-start
              .calendar
                %span.ico-calender-end
                %span.calendar-text= t 'booking_module.start'
            - if listing.action_hourly_booking?
              .hourly-booking.tab-pane.calendar-wrapper.time-picker{id: "hourly-booking-#{listing.id}"}
                .time
                  %span.ico-clock
                  %span.time-text= t 'booking_module.nine'
            - if listing.action_daily_booking? || (listing.action_free_booking? && !listing.action_hourly_booking? && !listing.subscription_booking?)
              .daily-booking.tab-pane.calendar-wrapper.date-end{id: "daily-booking-#{listing.id}"}
                .calendar
                  %span.ico-calender-start
                  %span.calendar-text= t 'booking_module.end'

        .clearfix
        - if listing.bookable?
          - rfq_class = nil
          - rfq_label = nil
          - registration_url = new_user_registration_path(return_to: location_url(listing.location, listing, restore_reservations: true))
          - store_reservation_request_url = store_reservation_request_listing_reservations_path(listing)
          - book_hash = { id: "book-#{listing.id}", class: "btn btn-green btn-large ", rel: "tooltip",
            :'data-original-title' => t('booking_module.notices.days_first'),
            :'data-behavior' => 'reviewBooking', :'data-listing-id' => listing.id,
            :'data-registration-url' => registration_url, :'data-store-reservation-request-url' => store_reservation_request_url,
            :'data-user-signed-in' => user_signed_in?, :'data-secured' => (not secure_links?), :'data-force-modal' => false}
          - if listing.subscription_booking?
            - form_options = { :url => review_listing_recurring_bookings_path(listing), data: { :'recurring-booking-form' => true, :'registration-url' => current_user ? nil :   new_user_registration_path(return_to: location_listing_url(listing.location, listing)), hourly: listing.action_hourly_booking? } }
          - else
            - form_options = { :url => review_listing_reservations_path(listing), html: { id: "reservation_request_form_#{listing.id}" } }
          .book
            = simple_form_for :reservation_request, form_options do |f|

              = render 'locations/hidden_fields', f: f, listing: listing
              - if listing.subscription_variants.many?
                .recurring-booking
                  #recurring-charges.hidden
                  .controls
                    %label.radio
                      = t 'booking_module.weekly'
                      = f.radio_button 'interval', :weekly, data: { subscription: 'weekly' }, checked: true do
                        = radio_button_tag 'interval', :weekly
                    .or
                      = t 'form.or'
                    %label.radio
                      = t 'booking_module.monthly'
                      = f.radio_button 'interval', :monthly, data: { subscription: 'monthly' } do
                        = radio_button_tag 'interval', :monthly
              - else
                = f.input :interval, as: :hidden, input_html: { value: listing.subscription_variants.keys.first }

              - if listing.schedule_booking?
                = f.input :dates, label: false, input_html: { value: listing.first_available_occurrence[:text], :'data-fixed-date-select' => true, 'data-init-value' => listing.first_available_occurrence.to_json }
              - else
                = f.hidden_field :dates

              - if listing.action_rfq?
                - book_hash[:class] += (listing.action_free_booking? ? 'hidden' : 'span6')
                - rfq_class = (listing.action_free_booking? ? 'btn btn-green btn-large' :  'btn btn-gray-light btn-large offer-button span6' )
                - rfq_label = (listing.action_free_booking? ?  t('reservations.rfq') : t('reservations.offer'))

              = render 'locations/booking_module_listing_description_below_dates', listing: listing
              .clearfix
              = render 'locations/additional_charges', listing: listing
              = render 'locations/booking_module_listing_description_above_call_to_action', listing: listing
              = render 'locations/booking_module_call_to_actions', listing: listing, book_hash: book_hash.stringify_keys, rfq_class: rfq_class, rfq_label: rfq_label
              .clearfix
              = render 'locations/booking_module_listing_description_below_call_to_action', listing: listing

        - else
          = render 'locations/booking_module_not_bookable', listing: listing

    .clearfix

- lookup_context.transactable_type_id = old
