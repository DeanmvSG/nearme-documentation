{% content_for 'social_meta_tags' %}
  {% include 'shared/social_meta_for_object', object: listing, url: listing.show_path %}
{% endcontent_for %}
{% assign prices = listing.action_type.transactable_type_action_type.pricings | group_by: 'number_of_units' %}

{% assign collaborator = current_user | find_collaborator: listing %}
{% if collaborator != blank %}
  {% assign offer = listing.not_cancelled_orders | detect: user_id: collaborator.user.id %}
{% endif %}
{% assign title = platform_context.name | append: ' - ' | append: listing.name %}
{% title title %}
<main id="main">
  <div class="wrapper-a">
    <div class="back-to-search-results back-to-listings">
      <a href="{{ 'dashboard_company_transactable_type_transactables_path' | generate_url: listing.transactable_type.slug }}">Back to My Bookings</a>
    </div>

    <article class="box-a booking-a">
      <h1>{{ listing.name }}</h1>
      <div class="content">
        <div class="booking-properties">
          <div class="overview">
            <div class="state-{{ listing.state }}"><span>{{ listing.state | humanize }}</span></div>
            <div class="meta">
              Posted <b>{{ listing.created_at | time_ago_in_words }}</b> ago
            </div>
          </div>

          <div class="properties">
            <dl>
              <dt>Passenger Name:</dt>
              <dd>{{ listing.creator.first_name }}</dd>

              {% if collaborator != blank %}
              <dt>Invite Sent:</dt>
              <dd><time datetime="{{ collaborator.approved_by_owner_at }}">{{ collaborator.approved_by_owner_at | l: 'short'}}</time></dd>
              {% endif %}

              <dt>City:</dt>
              <dd>{{ listing.properties.city_name }}</dd>

              {% for language in listing.customizations_by_type['Languages'] %}
                {% capture langs %}{{ langs }}{% unless langs == blank %}, {% endunless %}{{ language.language }} ({{ language.fluency }}){% endcapture %}
              {% endfor %}

              {% if langs != blank %}
                <dt>Languages Spoken:</dt>
                <dd>{{ langs }}</dd>
              {% endif %}

              {% if listing.properties.number_of_passengers != blank %}
              <dt>Passengers:</dt>
              <dd>{{ listing.properties.number_of_passengers }}</dd>
              {% endif %}

              {% if listing.categories["Extras"]["children"].size > 0 %}
              <dt>Extras:</dt>
              <dd>{{ listing.categories["Extras"]["children"] | join: ', ' }}</dd>
              {% endif %}
              {% if listing.transactable_collaborators[0] != blank %}
                <dt>Price:</dt>
                {% assign driver_type_unit = listing.transactable_collaborators[0].user.buyer_profile.properties['driver_type_unit'] | minus: 0 %}
                {% assign price = prices[driver_type_unit].first %}
                {% assign total = price.fixed_price_f | times: listing.properties.duration %}
                <dd data-convert-price="{{ total }}">{{ total | pricify }}</dd>
              {% endif %}
            </dl>

            <dl>
              {% if listing.properties.trip_start_date != blank %}
              <dt>Date:</dt>
              <dd>{{ listing.properties.trip_start_date | l: 'short' }}</dd>
              {% endif %}

              {% if listing.properties.trip_start_time != blank %}
              <dt>Start Time:</dt>
              <dd>{{ listing.properties.trip_start_time | l: 'short' }}</dd>
              {% endif %}


              {% if transactable.properties.duration != blank %}
                {% assign duration = transactable.properties.duration %}
                <dt>Length: </dt>
                <dd>{{ duration }} {% if duration == 1 %}hour{% else %}hours{% endif %}</dd>
              {% endif %}

              {% if transactable.properties.unknown_location == blank %}
              <dt>Pickup Location:</dt>
              <dd><a href="https://www.google.com/maps/place/{{ transactable.location.address }}">{{ transactable.location.address }}</a></dd>
              {% endif %}

            </dl>
          </div>
        </div>

        <div class="booking-description">
          {% if listing.description != blank %}
          <h3>Trip Description:</h3>
          <p>{{ listing.description | nl2br }}</p>
          {% endif %}

          {% if listing.categories["Categories of Interest"]["children"].size > 0 %}
            <h3>Categories of Interest:</h3>
            <ul>
              {% for category in listing.categories["Categories of Interest"]["children"] %}
              <li>{{ category }}</li>
              {% endfor %}
            </ul>
          {% endif %}

          {% if listing.properties.special_requests != blank %}
          <h3>Special Requests:</h3>
          <p>{{ listing.properties.special_requests }}</p>
          {% endif %}
        </div>
      </div>


      <aside class="sidebar">
        <ul class="actions-a">

          {% if current_user.id == collaborator.user.id and offer == blank %}
            <li>
              {% if current_user.has_verified_merchant_account == true %}
                {% assign pricing = listing.action_type.pricings | detect: number_of_units: current_user.buyer_properties.driver_type_unit %}
                {% assign url = 'new_dashboard_order_path' | generate_url: transactable_id: transactable.id, quantity: transactable.properties.duration, transactable_pricing_id: pricing.id %}
                <a class="button-a" data-href="{{ url }}" href="{{ url }}" data-modal="true">Accept</a>
                {% else %}
                {% assign url = 'required_modal_dashboard_company_payouts_path' | generate_url %}
                <a class="button-a" data-modal="true" href="{{ url }}" data-href="{{ url }}">Accept</a>
              {% endif %}
            </li>
            {% if current_user.id == collaborator.user.id and offer == blank %}
              <li>
                <a class="button-b" href="{{ 'dashboard_transactable_collaborator_path' | generate_url: collaborator.id }}" data-method="delete" data-confirm="Are you sure you want to decline this booking?">Decline</a>
              </li>
            {% endif %}
          {% endif %}

          {% if collaborator != blank and collaborator.user.id == current_user.id %}
            <li><a class="button-b action-message" data-modal="true" data-href="{{ listing.creator.user_message_path }}">Send Message</a></li>
          {% endif %}
        </ul>

        <figure class="avatar">
          <img src="{{ listing.creator.avatar_url_big }}" alt="{{ listing.creator.name }}">
        </figure>

        <h3 class="name">{{ listing.creator.name }}</h3>

        {% if listing.creator.properties.about %}
          {{ listing.creator.properties.about | nl2br }}
        {% endif %}

        {% if listing.creator.seller_avarage_rating > 0 %}
        <div class="rating-a" data-rating="{{ listing.creator.seller_avarage_rating | default: 0 }}">{{ listing.creator.seller_avarage_rating | default: 0 }} out of 5 stars</div>
        {% endif %}

        <ul class="user-properties">
          <li><b>{{ listing.creator.transactables_count }}</b> Bookings Requested</li>
          <li><b>{{ listing.creator.completed_transactables_count }}</b> Bookings Completed</li>
          <li>{{ 'registrations.member_since' | translate }} {{ listing.creator.created_at | to_date | l: 'short' }}</li>
        </ul>

        {% if listing.creator.has_active_credit_cards? %}
        <p class="payment-verified">
          <strong>Payment Method Verified</strong>
        </p>
        {% endif %}

        <ul class="actions-a">
          <li><a data-href="{{ listing.inappropriate_report_path }}" data-modal="true" class="button-c action-flag mini">Flag as inappropriate</a></li>
        </ul>
      </aside>
    </article>
  </div>
</main>
